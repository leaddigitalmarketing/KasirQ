<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kasir Offline - POS</title>
<style>
  :root{
    --bg:#f6f8fb;
    --card:#ffffff;
    --accent:#0b72ff;
    --muted:#6b7280;
    --success:#16a34a;
    --danger:#ef4444;
    --glass: rgba(255,255,255,0.7);
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#f6f8fb,#eef3ff);color:#0f172a;min-height:100vh}
  header{
    display:flex;align-items:center;justify-content:space-between;padding:14px 18px;
    background:var(--card);box-shadow:0 1px 6px rgba(16,24,40,0.06);
    position:sticky;top:0;z-index:20;
  }
  .brand{display:flex;align-items:center;gap:12px}
  .logo{
    width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7ab1ff);
    display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px;
  }
  .title{font-weight:700}
  nav{display:flex;gap:8px;align-items:center}
  .tab{
    padding:8px 12px;border-radius:8px;background:transparent;border:1px solid transparent;color:var(--muted);cursor:pointer;font-weight:600;
  }
  .tab.active{background:linear-gradient(90deg,var(--accent),#6aa8ff);color:white;border-color: rgba(11,114,255,0.12)}
  main{padding:18px;max-width:1100px;margin:18px auto}
  .grid{display:grid;gap:14px}
  /* responsive columns */
  .two-col{grid-template-columns: 1fr 380px}
  @media (max-width:980px){ .two-col{grid-template-columns:1fr} }
  .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(11,72,150,0.03);}
  h2{margin:0 0 12px 0;font-size:18px}
  /* product list */
  .controls{display:flex;gap:10px;flex-wrap:wrap}
  .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:white}
  .btn.ghost{background:transparent;border:1px solid #e6eefc;color:var(--accent)}
  .btn.warn{background:linear-gradient(90deg,#ff9a4d,#ff6a3d);color:white}
  .input, .select{
    padding:10px;border-radius:8px;border:1px solid #e6eefc;background:#fbfdff;min-width:0;
  }
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;text-align:left;border-bottom:1px solid #f1f5f9;font-size:14px}
  th{color:var(--muted);font-weight:700}
  .muted{color:var(--muted);font-size:13px}
  .right{text-align:right}
  .small{font-size:13px}
  .actions{display:flex;gap:8px}
  /* cart */
  .cart-item{display:flex;gap:8px;align-items:center;padding:8px 0;border-bottom:1px dashed #eef4ff}
  .cart-item:last-child{border-bottom:0}
  .badge{background:#eef6ff;color:var(--accent);padding:4px 8px;border-radius:999px;font-weight:700}
  /* modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(3,7,18,0.45);display:flex;align-items:center;justify-content:center;z-index:60}
  .modal{width:94%;max-width:720px;background:var(--card);border-radius:12px;padding:16px;box-shadow:0 20px 60px rgba(2,6,23,0.4)}
  .row{display:flex;gap:10px;align-items:center}
  .col{flex:1}
  .center{text-align:center}
  .invoice{font-family: "Courier New", monospace; background: #fff; padding: 16px; border-radius:8px;}
  footer{margin-top:18px;color:var(--muted);font-size:13px;text-align:center}
  /* nice table scroll */
  .table-wrap{overflow:auto;max-height:420px}
  /* tiny */
  .muted-2{color:#94a3b8}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">POS</div>
    <div>
      <div class="title">Kasir Offline</div>
      <div class="muted" style="font-size:12px">Simpan data: localStorage — Offline ready</div>
    </div>
  </div>

  <nav>
    <button class="tab active" data-tab="stok">Stok Produk</button>
    <button class="tab" data-tab="transaksi">Transaksi Kasir</button>
    <button class="tab" data-tab="laporan">Laporan</button>
  </nav>
</header>

<main>
  <!-- STOK -->
  <section id="stok" class="grid">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2>Stok Produk</h2>
        <div class="controls">
          <input id="searchProduct" class="input" placeholder="Cari produk..." />
          <button id="btnAddProduct" class="btn primary">+ Produk Baru</button>
        </div>
      </div>

      <div class="table-wrap" style="margin-top:12px">
        <table id="productsTable">
          <thead>
            <tr>
              <th>Nama Produk</th>
              <th>Satuan</th>
              <th>Harga Modal</th>
              <th>Harga Ecer</th>
              <th>Harga Grosir</th>
              <th class="right">Stok</th>
              <th>Aksi</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <footer class="muted-2">Data tersimpan di perangkat ini. Untuk sinkron, gunakan server / cloud.</footer>
    </div>
  </section>

  <!-- TRANSAKSI -->
  <section id="transaksi" class="grid" style="display:none">
    <div class="two-col grid">
      <div class="card">
        <h2>Kasir - Transaksi</h2>
        <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap">
          <input id="productSearchInput" class="input" placeholder="Cari produk atau ketik manual..." />
          <input id="qtyInput" type="number" min="1" class="input" style="width:110px" value="1" />
          <div style="display:flex;gap:8px">
            <button id="btnAddToCart" class="btn primary">Tambah</button>
            <button id="btnClearCart" class="btn ghost">Kosongkan</button>
          </div>
        </div>

        <div class="muted small">Jika jumlah per item >= 5 → harga grosir; jika kurang dari 5 → harga ecer.</div>

        <div style="margin-top:14px">
          <h3 style="margin:0 0 8px 0">Keranjang</h3>
          <div id="cartList"></div>

          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px">
            <div class="muted">Total Items: <span id="cartCount">0</span></div>
            <div style="text-align:right">
              <div class="muted small">Subtotal</div>
              <div style="font-weight:800;font-size:18px" id="cartTotal">Rp 0</div>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="btnContinue" class="btn">Lanjut tambah barang</button>
            <button id="btnFinish" class="btn warn">Selesai Transaksi</button>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Ringkasan</h2>
        <div style="margin-top:8px">
          <div style="display:flex;justify-content:space-between;padding:8px 0">
            <div>Item Count</div>
            <div id="summaryItems">0</div>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0">
            <div>Subtotal</div>
            <div id="summarySubtotal">Rp 0</div>
          </div>
          <div style="display:flex;justify-content:space-between;padding:8px 0;font-weight:700">
            <div>Total Bayar</div>
            <div id="summaryTotal">Rp 0</div>
          </div>
        </div>

        <hr />
        <div class="muted small">Tips: gunakan kotak pencarian untuk menemukan produk lebih cepat. Anda juga bisa mengetik nama produk baru untuk penjualan manual.</div>
      </div>
    </div>
  </section>

  <!-- LAPORAN -->
  <section id="laporan" style="display:none">
    <div class="card">
      <h2>Laporan Penjualan</h2>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:12px">
        <select id="reportMode" class="select input" style="width:160px">
          <option value="hari">Hari</option>
          <option value="minggu">Minggu</option>
          <option value="bulan" selected>Bulan</option>
          <option value="rentang">Rentang Tanggal</option>
        </select>
        <input id="reportDate" type="date" class="input" />
        <input id="reportDateTo" type="date" class="input" style="display:none" />
        <button id="btnGenerate" class="btn primary">Generate</button>
        <button id="btnExportCSV" class="btn ghost">Export CSV</button>
      </div>

      <div class="table-wrap">
        <table id="reportTable">
          <thead>
            <tr>
              <th>Nama Barang</th>
              <th>Jumlah Terjual</th>
              <th>Harga Modal (avg)</th>
              <th>Harga Jual (avg)</th>
              <th>Laba</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>
</main>

<!-- MODAL: Add/Edit Product -->
<div id="modalProduct" style="display:none" class="modal-backdrop">
  <div class="modal">
    <h3 id="modalTitle">Tambah Produk</h3>
    <div style="display:grid;gap:8px;margin-top:8px">
      <input id="p_name" class="input" placeholder="Nama produk" />
      <input id="p_unit" class="input" placeholder="Satuan (pcs, pack, kg...)" />
      <input id="p_cost" class="input" type="number" placeholder="Harga Modal (angka saja)" />
      <input id="p_price_ecer" class="input" type="number" placeholder="Harga Jual Ecer" />
      <input id="p_price_grosir" class="input" type="number" placeholder="Harga Jual Grosir (qty>=5)" />
      <input id="p_stock" class="input" type="number" placeholder="Stok (angka)" />
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
        <button id="btnCancelProduct" class="btn">Batal</button>
        <button id="btnSaveProduct" class="btn primary">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Invoice -->
<div id="modalInvoice" style="display:none" class="modal-backdrop">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>Invoice Transaksi</h3>
      <div id="invoiceTime" class="muted small"></div>
    </div>
    <div id="invoiceBody" style="margin-top:8px" class="invoice">
      <!-- dynamic -->
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button id="btnCloseInvoice" class="btn">Tutup</button>
      <button id="btnPrintInvoice" class="btn primary">Cetak / Print</button>
    </div>
  </div>
</div>

<script>
/* ------------------------
  Storage helpers
---------------------------*/
const DBKEY = 'kasir_offline_v1';
const TXKEY = 'kasir_offline_tx_v1';

function loadProducts(){
  try{
    const raw = localStorage.getItem(DBKEY);
    return raw? JSON.parse(raw) : [];
  }catch(e){ return []; }
}
function saveProducts(arr){
  localStorage.setItem(DBKEY, JSON.stringify(arr));
}
function loadTx(){
  try{
    const raw = localStorage.getItem(TXKEY);
    return raw? JSON.parse(raw) : [];
  }catch(e){ return []; }
}
function saveTx(arr){
  localStorage.setItem(TXKEY, JSON.stringify(arr));
}

/* ------------------------
  Utilities
---------------------------*/
function formatRp(v){
  v = Number(v)||0;
  return 'Rp ' + v.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
function uid(){
  return 'id' + Date.now().toString(36) + Math.random().toString(36).slice(2,6);
}

/* ------------------------
  PRODUCT: CRUD UI
---------------------------*/
let products = loadProducts();
const productsTbody = document.querySelector('#productsTable tbody');
const searchProductInput = document.getElementById('searchProduct');
const btnAddProduct = document.getElementById('btnAddProduct');

function renderProducts(filter=''){
  productsTbody.innerHTML = '';
  const f = filter.trim().toLowerCase();
  const list = products.filter(p => !f || (p.name && p.name.toLowerCase().includes(f)));
  if(list.length === 0){
    productsTbody.innerHTML = '<tr><td colspan="7" class="muted">Belum ada produk</td></tr>';
    return;
  }
  list.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${escapeHtml(p.name)}</strong><div class="muted small">${p.id}</div></td>
      <td>${escapeHtml(p.unit||'--')}</td>
      <td>${formatRp(p.cost)}</td>
      <td>${formatRp(p.price_ecer)}</td>
      <td>${formatRp(p.price_grosir)}</td>
      <td class="right">${p.stock||0}</td>
      <td class="actions">
        <button class="btn" data-action="edit" data-id="${p.id}">Edit</button>
        <button class="btn" data-action="delete" data-id="${p.id}">Hapus</button>
      </td>
    `;
    productsTbody.appendChild(tr);
  });
}

searchProductInput.addEventListener('input', e => renderProducts(e.target.value));

productsTbody.addEventListener('click', e=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const action = btn.dataset.action;
  const id = btn.dataset.id;
  if(action === 'edit') openProductModal('edit', id);
  if(action === 'delete'){
    if(confirm('Hapus produk ini?')) {
      products = products.filter(p => p.id !== id);
      saveProducts(products);
      renderProducts(searchProductInput.value);
    }
  }
});

btnAddProduct.addEventListener('click', ()=> openProductModal('add'));

/* Add/Edit modal logic */
const modalProduct = document.getElementById('modalProduct');
const modalTitle = document.getElementById('modalTitle');
const p_name = document.getElementById('p_name');
const p_unit = document.getElementById('p_unit');
const p_cost = document.getElementById('p_cost');
const p_price_ecer = document.getElementById('p_price_ecer');
const p_price_grosir = document.getElementById('p_price_grosir');
const p_stock = document.getElementById('p_stock');
const btnCancelProduct = document.getElementById('btnCancelProduct');
const btnSaveProduct = document.getElementById('btnSaveProduct');

let editingId = null;
function openProductModal(mode='add', id=null){
  modalProduct.style.display = 'flex';
  if(mode === 'add'){
    modalTitle.innerText = 'Tambah Produk';
    p_name.value=''; p_unit.value=''; p_cost.value=''; p_price_ecer.value=''; p_price_grosir.value=''; p_stock.value='';
    editingId = null;
  } else {
    modalTitle.innerText = 'Edit Produk';
    const pr = products.find(x=>x.id===id);
    if(!pr) return alert('Produk tidak ditemukan');
    editingId = id;
    p_name.value = pr.name; p_unit.value = pr.unit; p_cost.value = pr.cost; p_price_ecer.value = pr.price_ecer;
    p_price_grosir.value = pr.price_grosir; p_stock.value = pr.stock;
  }
}
btnCancelProduct.addEventListener('click', ()=> modalProduct.style.display = 'none');

btnSaveProduct.addEventListener('click', ()=>{
  const name = p_name.value.trim();
  if(!name) return alert('Nama produk wajib diisi');
  const data = {
    name,
    unit: p_unit.value.trim() || '-',
    cost: Number(p_cost.value) || 0,
    price_ecer: Number(p_price_ecer.value) || 0,
    price_grosir: Number(p_price_grosir.value) || 0,
    stock: Number(p_stock.value) || 0
  };
  if(editingId){
    products = products.map(x => x.id === editingId ? {...x, ...data} : x);
  } else {
    const newp = {...data, id: uid()};
    products.push(newp);
  }
  saveProducts(products);
  modalProduct.style.display = 'none';
  renderProducts(searchProductInput.value);
  renderProductSuggestions();
});

/* ------------------------
  TRANSAKSI (Cart) LOGIC
---------------------------*/
let cart = []; // {id,name,unit,qty,price,cost}
const productSearchInput = document.getElementById('productSearchInput');
const qtyInput = document.getElementById('qtyInput');
const btnAddToCart = document.getElementById('btnAddToCart');
const cartList = document.getElementById('cartList');
const cartCount = document.getElementById('cartCount');
const cartTotal = document.getElementById('cartTotal');
const btnClearCart = document.getElementById('btnClearCart');
const btnFinish = document.getElementById('btnFinish');
const btnContinue = document.getElementById('btnContinue');
const summaryItems = document.getElementById('summaryItems');
const summarySubtotal = document.getElementById('summarySubtotal');
const summaryTotal = document.getElementById('summaryTotal');

function renderProductSuggestions(){
  // datalist-like behaviour: create array of names
  // For simplicity we'll not create DOM datalist; instead provide keyboard autocomplete via suggestions
}
renderProductSuggestions();

function findProductByName(name){
  name = (name||'').trim().toLowerCase();
  return products.find(p => p.name && p.name.toLowerCase() === name);
}

btnAddToCart.addEventListener('click', ()=>{
  const rawName = productSearchInput.value.trim();
  if(!rawName) return alert('Masukkan nama produk atau cari produk terlebih dahulu');
  let prod = findProductByName(rawName);
  const qty = Math.max(1, Number(qtyInput.value) || 1);

  if(prod){
    // choose price: if qty >=5 use grosir else ecer
    const price = qty >= 5 ? Number(prod.price_grosir) : Number(prod.price_ecer);
    if(price <= 0) {
      if(!confirm('Harga produk masih 0. Lanjutkan?')) return;
    }
    cart.push({
      id: prod.id,
      name: prod.name,
      unit: prod.unit,
      qty,
      price,
      cost: Number(prod.cost)
    });
  } else {
    // manual item entry
    const manualPrice = Number(prompt('Produk tidak ditemukan — masukkan harga jual untuk produk manual (angka saja):', '0')) || 0;
    const manualCost = Number(prompt('Masukkan harga modal (angka saja):', '0')) || 0;
    cart.push({
      id: uid(),
      name: rawName,
      unit: '-',
      qty,
      price: manualPrice,
      cost: manualCost
    });
  }
  productSearchInput.value = '';
  qtyInput.value = '1';
  renderCart();
});

function renderCart(){
  cartList.innerHTML = '';
  if(cart.length === 0) cartList.innerHTML = '<div class="muted">Keranjang kosong</div>';
  let total = 0, items = 0;
  cart.forEach((it,idx)=>{
    total += it.price * it.qty;
    items += it.qty;
    const el = document.createElement('div');
    el.className = 'cart-item';
    el.innerHTML = `
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>${escapeHtml(it.name)}</strong> <div class="muted small">${escapeHtml(it.unit)}</div></div>
          <div class="right">${formatRp(it.price)} x ${it.qty}</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" data-idx="${idx}" data-act="dec">-</button>
        <button class="btn" data-idx="${idx}" data-act="inc">+</button>
        <button class="btn" data-idx="${idx}" data-act="del">hapus</button>
      </div>
    `;
    cartList.appendChild(el);
  });
  cartCount.innerText = cart.length;
  cartTotal.innerText = formatRp(total);
  summaryItems.innerText = cart.length;
  summarySubtotal.innerText = formatRp(total);
  summaryTotal.innerText = formatRp(total);
}

cartList.addEventListener('click', e=>{
  const b = e.target.closest('button');
  if(!b) return;
  const idx = Number(b.dataset.idx);
  const act = b.dataset.act;
  if(act === 'inc') { cart[idx].qty += 1; maybeUpdatePriceForCartItem(idx); }
  if(act === 'dec') { cart[idx].qty = Math.max(1, cart[idx].qty - 1); maybeUpdatePriceForCartItem(idx); }
  if(act === 'del') { cart.splice(idx,1); }
  renderCart();
});

function maybeUpdatePriceForCartItem(idx){
  // If item corresponds to stored product, update price based on qty rule
  const item = cart[idx];
  const prod = products.find(p=>p.id===item.id || p.name.toLowerCase()===item.name.toLowerCase());
  if(prod){
    item.price = item.qty >= 5 ? Number(prod.price_grosir) : Number(prod.price_ecer);
  }
}

/* Clear cart */
btnClearCart.addEventListener('click', ()=>{
  if(confirm('Kosongkan semua keranjang?')) { cart = []; renderCart(); }
});

/* Continue (just keep adding) */
btnContinue.addEventListener('click', ()=> {
  alert('Lanjut tambah barang — Silakan tambah produk berikutnya.');
});

/* Finish -> show invoice modal and save transaction */
const modalInvoice = document.getElementById('modalInvoice');
const invoiceBody = document.getElementById('invoiceBody');
const invoiceTime = document.getElementById('invoiceTime');
const btnCloseInvoice = document.getElementById('btnCloseInvoice');
const btnPrintInvoice = document.getElementById('btnPrintInvoice');

btnFinish.addEventListener('click', ()=>{
  if(cart.length === 0) return alert('Keranjang kosong.');
  // create transaction object
  const tx = {
    id: uid(),
    ts: new Date().toISOString(),
    items: cart.map(i => ({...i})),
    subtotal: cart.reduce((s,i)=>s + i.price*i.qty,0)
  };
  // Save transaction to local storage
  const txs = loadTx();
  txs.push(tx);
  saveTx(txs);

  // Deduct stock for known products
  tx.items.forEach(it=>{
    const prod = products.find(p=>p.id===it.id);
    if(prod){
      prod.stock = Math.max(0, (Number(prod.stock)||0) - Number(it.qty));
    }
  });
  saveProducts(products);

  // Show invoice modal
  showInvoice(tx);
  cart = []; renderCart();
  renderProducts(searchProductInput.value);
});

function showInvoice(tx){
  invoiceTime.innerText = new Date(tx.ts).toLocaleString();
  const lines = tx.items.map(it=>{
    const laba = (Number(it.price) - Number(it.cost)) * Number(it.qty);
    return `<div style="display:flex;justify-content:space-between;margin:6px 0">
      <div><strong>${escapeHtml(it.name)}</strong><div class="muted small">${it.qty} x ${formatRp(it.price)}</div></div>
      <div style="text-align:right">${formatRp(Number(it.price)*Number(it.qty))}</div>
      </div>
      <div class="muted small">Laba item: ${formatRp(laba)}</div>`;
  }).join('<hr style="border:none;border-top:1px dashed #eee;margin:8px 0">');
  const total = tx.subtotal;
  invoiceBody.innerHTML = `
    <div style="text-align:center;font-weight:800;margin-bottom:6px">TOKO ANDA</div>
    <div class="muted small">Nota: ${tx.id}</div>
    <div style="margin-top:8px">${lines}</div>
    <hr />
    <div style="display:flex;justify-content:space-between;font-weight:800">
      <div>Total</div><div>${formatRp(total)}</div>
    </div>
    <div class="muted small" style="margin-top:8px">Terima kasih. Silakan simpan struk ini.</div>
  `;
  modalInvoice.style.display = 'flex';
}

btnCloseInvoice.addEventListener('click', ()=> modalInvoice.style.display = 'none');
btnPrintInvoice.addEventListener('click', ()=> {
  // Open print-friendly window
  const w = window.open('', '_blank');
  w.document.write('<pre style="font-family:monospace">'+document.getElementById('invoiceBody').innerHTML+'</pre>');
  w.document.close();
  w.print();
});

/* ------------------------
  REPORTS
---------------------------*/
const reportMode = document.getElementById('reportMode');
const reportDate = document.getElementById('reportDate');
const reportDateTo = document.getElementById('reportDateTo');
const btnGenerate = document.getElementById('btnGenerate');
const reportTableTbody = document.querySelector('#reportTable tbody');
const btnExportCSV = document.getElementById('btnExportCSV');

function updateReportInputs(){
  const mode = reportMode.value;
  if(mode === 'rentang'){
    reportDateTo.style.display = 'inline-block';
  } else {
    reportDateTo.style.display = 'none';
  }
  // default date selects
  const now = new Date();
  const y = now.getFullYear(), m = String(now.getMonth()+1).padStart(2,'0'), d = String(now.getDate()).padStart(2,'0');
  if(mode==='hari'){
    reportDate.value = `${y}-${m}-${d}`;
  } else if(mode==='bulan'){
    reportDate.value = `${y}-${m}-01`;
  } else if(mode==='minggu'){
    const monday = new Date(now); monday.setDate(now.getDate() - ((now.getDay()+6)%7));
    reportDate.value = monday.toISOString().slice(0,10);
  }
}
reportMode.addEventListener('change', updateReportInputs);
updateReportInputs();

function generateReport(){
  const mode = reportMode.value;
  const txs = loadTx();
  let from=null, to=null;
  if(mode === 'rentang'){
    if(!reportDate.value || !reportDateTo.value) return alert('Pilih tanggal awal dan akhir');
    from = new Date(reportDate.value);
    to = new Date(reportDateTo.value);
    to.setHours(23,59,59,999);
  } else if(mode === 'hari'){
    from = new Date(reportDate.value);
    from.setHours(0,0,0,0);
    to = new Date(reportDate.value);
    to.setHours(23,59,59,999);
  } else if(mode === 'bulan'){
    from = new Date(reportDate.value);
    from.setHours(0,0,0,0);
    const mm = new Date(from.getFullYear(), from.getMonth()+1, 0);
    to = new Date(mm); to.setHours(23,59,59,999);
  } else if(mode === 'minggu'){
    from = new Date(reportDate.value); from.setHours(0,0,0,0);
    to = new Date(from); to.setDate(from.getDate() + 6); to.setHours(23,59,59,999);
  }
  // accumulate per product name
  const map = {};
  txs.forEach(tx=>{
    const ttime = new Date(tx.ts);
    if(from && to && (ttime < from || ttime > to)) return;
    tx.items.forEach(it=>{
      const key = it.name;
      if(!map[key]) map[key] = {name:it.name, qty:0, totalCost:0, totalSell:0};
      map[key].qty += Number(it.qty);
      map[key].totalCost += Number(it.cost) * Number(it.qty);
      map[key].totalSell += Number(it.price) * Number(it.qty);
    });
  });
  // render table
  reportTableTbody.innerHTML = '';
  const rows = Object.values(map);
  if(rows.length === 0) {
    reportTableTbody.innerHTML = '<tr><td colspan="5" class="muted">Tidak ada penjualan pada periode ini</td></tr>';
    return;
  }
  rows.forEach(r=>{
    const avgCost = r.totalCost / (r.qty || 1);
    const avgSell = r.totalSell / (r.qty || 1);
    const laba = r.totalSell - r.totalCost;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHtml(r.name)}</td>
      <td>${r.qty}</td>
      <td>${formatRp(Math.round(avgCost))}</td>
      <td>${formatRp(Math.round(avgSell))}</td>
      <td>${formatRp(Math.round(laba))}</td>`;
    reportTableTbody.appendChild(tr);
  });
}

btnGenerate.addEventListener('click', generateReport);

btnExportCSV.addEventListener('click', ()=>{
  // export current rendered table
  const rows = Array.from(document.querySelectorAll('#reportTable tr')).map(tr=>{
    return Array.from(tr.querySelectorAll('th,td')).map(td => td.innerText.replace(/\n/g,' ').trim());
  });
  if(rows.length <= 1) return alert('Tidak ada data untuk diexport');
  const csv = rows.map(r => r.map(v => `"${v.replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'laporan.csv'; a.click();
  URL.revokeObjectURL(url);
});

/* ------------------------
  TAB SWITCH
---------------------------*/
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    document.querySelectorAll('main section').forEach(sec=> sec.style.display = 'none');
    document.getElementById(tab).style.display = (tab==='stok'? 'block':'block');
    if(tab === 'stok'){ document.getElementById('stok').style.display = 'block'; document.getElementById('transaksi').style.display = 'none'; document.getElementById('laporan').style.display='none'; }
    if(tab === 'transaksi'){ document.getElementById('stok').style.display = 'none'; document.getElementById('transaksi').style.display = 'block'; document.getElementById('laporan').style.display='none'; }
    if(tab === 'laporan'){ document.getElementById('stok').style.display = 'none'; document.getElementById('transaksi').style.display = 'none'; document.getElementById('laporan').style.display='block'; }
  });
});

/* ------------------------
  Small helpers & init
---------------------------*/
function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];});
}

/* On load */
(function init(){
  renderProducts('');
  renderCart();
})();

/* Keyboard: Enter triggers add to cart from transaksi input */
productSearchInput.addEventListener('keypress', e => {
  if(e.key === 'Enter') btnAddToCart.click();
});
qtyInput.addEventListener('keypress', e => {
  if(e.key === 'Enter') btnAddToCart.click();
});

/* Accessibility: close modal on backdrop click */
[modalProduct, modalInvoice].forEach(mod => {
  mod.addEventListener('click', e => {
    if(e.target === mod) mod.style.display = 'none';
  });
});

</script>
</body>
</html>
